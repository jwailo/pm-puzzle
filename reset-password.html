<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - The PM Puzzle</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="game-container">
        <header class="header">
            <div class="title">
                <div class="brand-text">Ailo presents</div>
                <h1>The PM Puzzle</h1>
                <div class="subtitle">Password Reset</div>
            </div>
        </header>
        
        <div class="auth-section">
            <div class="auth-form">
                <h2>Reset Your Password</h2>
                <p style="margin-bottom: 20px; color: var(--color-text);">Enter your new password below.</p>
                
                <form id="reset-password-form">
                    <input type="password" id="new-password" placeholder="New Password" required minlength="6">
                    <input type="password" id="confirm-password" placeholder="Confirm New Password" required minlength="6">
                    <button type="submit" id="reset-submit">Reset Password</button>
                </form>
                
                <div id="reset-message" style="margin-top: 16px; text-align: center;"></div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <a href="index.html" class="link-btn">‚Üê Back to Game</a>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        class PasswordReset {
            constructor() {
                this.supabase = window.supabaseClient;
                this.setupEventListeners();
                this.checkAuthState();
            }
            
            setupEventListeners() {
                const form = document.getElementById('reset-password-form');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.resetPassword();
                });
            }
            
            async checkAuthState() {
                console.log('Checking auth state...');
                console.log('URL:', window.location.href);
                console.log('Search params:', window.location.search);
                console.log('Hash:', window.location.hash);
                
                // Handle Supabase auth callback
                try {
                    const { data, error } = await this.supabase.auth.getSession();
                    console.log('Current session:', data);
                    
                    if (error) {
                        console.error('Session error:', error);
                        this.showMessage('Error verifying reset link: ' + error.message, 'error');
                        return;
                    }
                    
                    if (data?.session?.user) {
                        console.log('Valid session found for user:', data.session.user.email);
                        this.showMessage('Reset link verified! Please enter your new password.', 'success');
                        
                        // Enable the form
                        document.getElementById('reset-password-form').style.display = 'block';
                    } else {
                        // Try to handle auth from URL fragments
                        await this.handleAuthFromUrl();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    this.showMessage('Error verifying reset link. Please try again.', 'error');
                }
            }
            
            async handleAuthFromUrl() {
                // Check for auth tokens in URL
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const searchParams = new URLSearchParams(window.location.search);
                
                const accessToken = hashParams.get('access_token') || searchParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token') || searchParams.get('refresh_token');
                const type = hashParams.get('type') || searchParams.get('type');
                
                console.log('URL tokens:', { accessToken: !!accessToken, refreshToken: !!refreshToken, type });
                
                if (type === 'recovery' && accessToken) {
                    try {
                        // Set session with the tokens from URL
                        const { error } = await this.supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken || ''
                        });
                        
                        if (error) throw error;
                        
                        this.showMessage('Reset link verified! Please enter your new password.', 'success');
                        document.getElementById('reset-password-form').style.display = 'block';
                        
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                    } catch (error) {
                        console.error('Error setting session from URL:', error);
                        this.showMessage('Invalid or expired reset link. Please request a new one.', 'error');
                        this.redirectToGame();
                    }
                } else {
                    console.log('No valid reset tokens found in URL');
                    this.showMessage('Invalid or expired reset link. Please request a new one.', 'error');
                    this.redirectToGame();
                }
            }
            
            redirectToGame() {
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
            
            async resetPassword() {
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const submitBtn = document.getElementById('reset-submit');
                
                if (newPassword !== confirmPassword) {
                    this.showMessage('Passwords do not match', 'error');
                    return;
                }
                
                if (newPassword.length < 6) {
                    this.showMessage('Password must be at least 6 characters', 'error');
                    return;
                }
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Resetting...';
                    
                    const { error } = await this.supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    this.showMessage('Password reset successful! Redirecting to game...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Password reset error:', error);
                    this.showMessage('Error: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Reset Password';
                }
            }
            
            showMessage(text, type) {
                const messageDiv = document.getElementById('reset-message');
                messageDiv.textContent = text;
                messageDiv.style.color = type === 'success' ? 'var(--color-correct)' : 'var(--color-error)';
                messageDiv.style.fontWeight = '600';
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new PasswordReset();
        });
    </script>
</body>
</html>